<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Testara Employee Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{
  box-sizing:border-box;
  font-family: "Segoe UI", Arial, sans-serif;
}

body{
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#1e3a8a,#2563eb);
}

/* Card */
.login-card{
  background:#fff;
  width:100%;
  max-width:420px;
  padding:40px 32px;
  border-radius:18px;
  box-shadow:0 25px 50px rgba(0,0,0,0.15);
  animation:fadeIn .5s ease;
}

@keyframes fadeIn{
  from{opacity:0; transform:translateY(15px)}
  to{opacity:1; transform:translateY(0)}
}

.logo{
  text-align:center;
  font-size:24px;
  font-weight:700;
  color:#004aad;
  margin-bottom:6px;
}

.sub{
  text-align:center;
  font-size:13px;
  color:#6b7280;
  margin-bottom:28px;
}

.alert{
  display:none;
  padding:10px;
  border-radius:8px;
  margin-bottom:14px;
  font-size:13px;
}

.error{
  background:#fee2e2;
  color:#991b1b;
}

.field{
  margin-bottom:18px;
}

.field label{
  display:block;
  font-size:13px;
  margin-bottom:6px;
  color:#374151;
  font-weight:500;
}

.field input{
  width:100%;
  padding:12px 14px;
  font-size:14px;
  border-radius:10px;
  border:1px solid #d1d5db;
  outline:none;
  transition:.3s;
}

.field input:focus{
  border-color:#004aad;
  box-shadow:0 0 0 3px rgba(0,74,173,.12);
}

/* Forgot password link */
.forgot{
  text-align:right;
  margin-bottom:20px;
}

.forgot a{
  font-size:13px;
  color:#004aad;
  text-decoration:none;
  font-weight:500;
  transition:.2s;
}

.forgot a:hover{
  text-decoration:underline;
  opacity:.8;
}

/* Button */
button{
  width:100%;
  padding:14px;
  font-size:15px;
  font-weight:600;
  border:none;
  border-radius:12px;
  background:#004aad;
  color:#fff;
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  transition:.3s;
}

button:hover{
  background:#00337c;
}

button:disabled{
  opacity:.7;
  cursor:not-allowed;
}

/* Loader */
.loader{
  width:18px;
  height:18px;
  border:3px solid rgba(255,255,255,.4);
  border-top:3px solid #fff;
  border-radius:50%;
  animation:spin 1s linear infinite;
  display:none;
}

@keyframes spin{
  to{transform:rotate(360deg)}
}

/* Success */
.success{
  display:none;
  font-size:18px;
  background:#22c55e;
  width:26px;
  height:26px;
  border-radius:50%;
  display:flex;
  justify-content:center;
  align-items:center;
  animation:pop .4s ease;
}

@keyframes pop{
  0%{transform:scale(0)}
  80%{transform:scale(1.2)}
  100%{transform:scale(1)}
}

.footer{
  margin-top:24px;
  text-align:center;
  font-size:12px;
  color:#9ca3af;
}
</style>
</head>

<body>

<div class="login-card">
  <!-- <p>Welcome back! Please login to continue</p> -->
  <div class="logo">Testara Employee Login</div>
  <div class="sub">Welcome back! Secure Company Login</div>

  <div id="alert" class="alert error"></div>

  <form id="loginForm">
    <div class="field">
      <label>Email</label>
      <input type="email" id="email" placeholder="employee@company.in" required>
    </div>

    <div class="field">
      <label>Password</label>
      <input type="password" id="password" placeholder="Password" required>
    </div>

    <div class="forgot">
      <a href="forgot-password.html">Forgot Password?</a>
    </div>

    <!-- <button type="submit">Login</button> -->
      <!-- <button id="btn" type="submit">Login</button> -->
      <button id="btn" type="submit">
        <span id="btnText">Login</span>
        <span id="loader" class="loader"></span>
        <span id="success" class="success">âœ”</span>
      </button>

  </form>

  <div class="footer">Â© 2025 Testara | Testara Admin Panel | Authorized users only</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://qzriaykqdrhbtcgbpxpg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6cmlheWtxZHJoYnRjZ2JweHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTcwMTAsImV4cCI6MjA3NTU5MzAxMH0.qRAQumkwN-JtxDizWwLRfPa8t0N68YGWdYKhQrhx7e8";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= HELPERS ================= */
const alertBox = document.getElementById("alert");
const btn = document.getElementById("btn");
const btnText = document.getElementById("btnText");
const loader = document.getElementById("loader");
const success = document.getElementById("success");

let failCount = Number(localStorage.getItem("login_fail")) || 0;
let timeoutRef;

/* ================= HELPERS ================= */
function startTimeout(){
  timeoutRef = setTimeout(()=>{
    showError("Request timeout. Please try again.");
  },10000);
}
function clearTimeoutSafe(){
  if(timeoutRef) clearTimeout(timeoutRef);
}

// function showLoading(){
//   alertBox.style.display = "none";
//   btn.disabled = true;          // âœ… REALLY disables
//   btnText.innerText = "Verifying...";
//   loader.style.display = "inline-block";
// }

function showLoading(){
  alertBox.style.display="none";
  btn.disabled=true;
  btnText.innerText="Verifying...";
  loader.style.display="inline-block";
  success.style.display="none";
  startTimeout();
}

function hideLoading(){
  btn.disabled = false;
  btnText.innerText = "Login";
  loader.style.display = "none";
}

// function showError(msg){
//   alertBox.innerText = msg;
//   alertBox.style.display = "block";
//   hideLoading();
// }

function showError(msg){
  clearTimeoutSafe();
  failCount++;
  localStorage.setItem("login_fail",failCount);
  alertBox.innerText=msg;
  alertBox.style.display="block";
  loader.style.display="none";
  btnText.innerText="Login";
  btn.disabled=false;
  if(failCount>=3) lockButton();
}

function showSuccess(){
  clearTimeoutSafe();
  loader.style.display="none";
  btnText.innerText="Success";
  success.style.display="flex";
  localStorage.removeItem("login_fail");
}

/* ðŸ” LOCK AFTER 3 FAILS */
function lockButton(){
  btn.disabled=true;
  let sec=30;
  btnText.innerText=`Locked (${sec}s)`;

  const timer=setInterval(()=>{
    sec--;
    btnText.innerText=`Locked (${sec}s)`;
    if(sec<=0){
      clearInterval(timer);
      btn.disabled=false;
      btnText.innerText="Login";
      localStorage.removeItem("login_fail");
    }
  },1000);
}

// /* ================= LOGIN ================= */
// document.getElementById("loginForm").addEventListener("submit", async (e)=>{
//   e.preventDefault();

//   const email = document.getElementById("email").value
//     .trim()
//     .toLowerCase();

//   const password = document.getElementById("password").value.trim();

//   if(!email || !password){
//     showError("Email and password are required");
//     return;
//   }

//   showLoading();

//   try{
//     /* ðŸ” RPC LOGIN (with lock logic in DB) */
//     const { data, error } = await sb.rpc("login_user", {
//       p_email: email,
//       p_password: password
//     });

//     /* âŒ LOGIN FAILED */
//     if(error){
//       // account lock message from DB
//       if(error.message.toLowerCase().includes("locked")){
//         showError(error.message);
//       }else{
//         showError("Invalid email or password");
//       }
//       return;
//     }

//     if(!data || data.length === 0){
//       showError("Invalid email or password");
//       return;
//     }

//     /* âœ… LOGIN SUCCESS */
//     const emp = data[0];

//     /* ðŸ” SESSION (8 HOURS) */
//     const SESSION_TTL = 1 * 60 * 60 * 1000;

//     const session = {
//       id: emp.id,
//       employee_id: emp.employee_id,
//       name: emp.name,
//       role: emp.role,
//       expires_at: Date.now() + SESSION_TTL
//     };

//     localStorage.setItem("employee", JSON.stringify(session));

//     /* ðŸ” UPDATE LAST LOGIN (SAFE) */
//     await sb.from("employees").update({ last_login: new Date().toISOString() }).eq("id", emp.id);

//     /* ðŸš¦ ROLE BASED REDIRECT */
//     if(emp.role === "admin"){
//       location.href = "/admin/admin-dashboard.html";
//     }else if(emp.role === "teacher"){
//       location.href = "/admin/teacher/dashboard.html";
//     }else if(emp.role === "accountant"){
//       location.href = "/admin/accounts/dashboard.html";
//     }else{
//       location.href = "/dashboard.html";
//     }

//   }catch(err){
//     console.error("Login error:", err);
//     showError("Something went wrong. Please try again.");
//   }
// });

/* ================= LOGIN ================= */
document.getElementById("loginForm").addEventListener("submit",async(e)=>{
  e.preventDefault();

  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value.trim();

  if(!email || !password){
    showError("Email and password are required");
    return;
  }
  showLoading();

  try{
    const {data,error}=await sb.rpc("login_user",{p_email:email,p_password:password});
    if(error||!data||!data.length) return showError("Invalid email or password");

    showSuccess();

    const emp=data[0];
    const session={
      id:emp.id,
      employee_id:emp.employee_id,
      name:emp.name,
      role:emp.role,
      expires_at:Date.now()+1*60*60*1000
    };
    localStorage.setItem("employee",JSON.stringify(session));

    /* ðŸ” UPDATE LAST LOGIN (SAFE) */
    await sb.from("employees").update({ last_login: new Date().toISOString() }).eq("id", emp.id);

    setTimeout(()=>location.href="/admin/dashboard.html",700);

  }catch(err){
    console.error("Login error:", err);
    showError("Something went wrong. Please try again.");
  }
});
</script>


</body>
</html>


