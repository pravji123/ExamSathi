<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Result - Testara</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J3KJB0Y4C6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3KJB0Y4C6');
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    header { background: #007bff; color: white; padding: 15px; text-align: center; font-size: 1.4rem; }
    .container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    th { background: #007bff; color: white; }
    .summary-box { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    .card { background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center; flex: 1; min-width: 120px; }
    .btn { padding: 10px 16px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .btn-primary { background: #007bff; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-success { background: #28a745; color: white; }
    .hidden { display: none; }
    .review-question { background: #fff; margin-bottom: 15px; padding: 15px; border-radius: 6px; border: 1px solid #ddd; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    .explanation { background: #f1f1f1; padding: 8px; margin-top: 8px; border-left: 4px solid #007bff; }
    table tr:nth-child(even) {
      background: #f0f0f0;
    }

  </style>
</head>
<body>
  <div id="header"></div>
  <div class="container">
    <header>üéâ Test Result - Summary</header>
    <div class="summary-box">
      <div class="card"><strong id="userName"></strong><br>üë§ Candidate</div>
      <div class="card"><strong id="totalQuestions"></strong><br>Total Questions</div>
      <div class="card"><strong id="attempted"></strong><br>Attempted</div>
      <div class="card"><strong id="correct"></strong><br>‚úÖ Correct</div>
      <div class="card"><strong id="wrong"></strong><br>‚ùå Wrong</div>
      <div class="card"><strong id="percentage"></strong>%<br>Percentage_Score</div>
      <div class="card"><strong id="timeTaken"></strong><br>‚è± Total Time</div>
    </div>

    <h2 style="text-align: center;">Section-Wise Summary</h2>
    <div id="sectionSummary"></div>

    <div style="text-align:center;">
      <button class="btn btn-primary" onclick="toggleReview()">üìñ Review Questions</button>
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">üè† Go Home</button>
    </div>

    <div id="reviewSection" class="hidden">
      <h2>Review Questions</h2>
      <div id="reviewList"></div>
    </div>
  </div>
  <div id="footer"></div><script src="load-header-footer.js"></script>

  <script>
    function loadResult(){
      const data = JSON.parse(localStorage.getItem("quizResult") || "{}");
      if(!data.questions){
        document.body.innerHTML = "<h2 style='text-align:center;color:red;'>No result found!</h2>";
        return;
      }

      const { name, total, correct, wrong, time, answers, questions, perQuestionTime, testTitle } = data;
      const attempted = correct + wrong;
      let score = 0;
      questions.forEach((q, i) => {
        const userAns = answers[i];
        if (userAns === q.answer) {
          score += 1; // or q.marks if present
        } else if (userAns && userAns !== "Not Answered") {
          score -= q.negative ?? 0; // ‚úÖ safe, only deduct if defined
        }
      });
      const percentage = ((score / total) * 100).toFixed(2);

      // ‚úÖ Fill summary cards
      document.getElementById("userName").innerText = name;
      document.getElementById("totalQuestions").innerText = total;
      document.getElementById("attempted").innerText = attempted;
      document.getElementById("correct").innerText = correct;
      document.getElementById("wrong").innerText = wrong;
      document.getElementById("percentage").innerText = percentage;
      document.getElementById("timeTaken").innerText = time;

      // ‚úÖ Section-wise Summary
      const sectionStats = {};  
      let grandTotal = { total: 0, attempted: 0, correct: 0, wrong: 0, score: 0, time: 0 };

      // Load section time from localStorage
      const sectionTime = JSON.parse(localStorage.getItem("sectionTime") || "{}");

      questions.forEach((q, i) => {
        const sec = q.section || "General";
        if(!sectionStats[sec]){
          sectionStats[sec] = { total: 0, correct: 0, wrong: 0, attempted: 0, score: 0, time: 0 };
        }
        sectionStats[sec].total++;
        grandTotal.total++;

        const userAns = answers[i];
        if(userAns){
          sectionStats[sec].attempted++;
          grandTotal.attempted++;

          if(userAns === q.answer){
            sectionStats[sec].correct++;
            grandTotal.correct++;
            const marks = q.marks ?? testData.marks ?? 1;
            sectionStats[sec].score += marks;
            grandTotal.score += marks;
          } else {
            sectionStats[sec].wrong++;
            grandTotal.wrong++;
            const neg = q.negative ?? testData.negative ?? 0;
            sectionStats[sec].score -= neg;
            grandTotal.score -= neg;
          }
        }
      });

      // ‚úÖ Add section times (convert sec ‚Üí mm:ss)
      for (const sec in sectionStats) {
        if (sectionTime[sec] !== undefined) {
          sectionStats[sec].time = sectionTime[sec];
          grandTotal.time += sectionTime[sec];
        }
      }

      function formatTime(seconds){
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}m ${s}s`;
      }


      let html = `<table>
        <thead>
          <tr>
            <th>Section</th>
            <th>Total</th>
            <th>Attempted</th>
            <th>Correct</th>
            <th>Wrong</th>
            <th>Score</th>
            <th>Accuracy</th>
          </tr>
        </thead>
        <tbody>`;

      for(const sec in sectionStats){
        const s = sectionStats[sec];
        const accuracy = ((s.correct / s.total) * 100).toFixed(2);
        html += `<tr>
          <td>${sec}</td>
          <td>${s.total}</td>
          <td>${s.attempted}</td>
          <td>${s.correct}</td>
          <td>${s.wrong}</td>
          <td>${s.score.toFixed(2)}</td>
          <td>${accuracy}%</td>
        </tr>`;
      }

      // ‚úÖ Add grand total row
      const grandAccuracy = ((grandTotal.correct / grandTotal.total) * 100).toFixed(2);
      html += `<tr style="font-weight:bold; background:#e0e0e0">
        <td>Total</td>
        <td>${grandTotal.total}</td>
        <td>${grandTotal.attempted}</td>
        <td>${grandTotal.correct}</td>
        <td>${grandTotal.wrong}</td>
        <td>${grandTotal.score.toFixed(2)}</td>
        <td>${grandAccuracy}%</td>
      </tr>`;

      html += `</tbody></table>`;
      document.getElementById("sectionSummary").innerHTML = html;


      // ‚úÖ Build Review List
      const reviewDiv = document.getElementById("reviewList");
      reviewDiv.innerHTML = "";

      questions.forEach((q, i) => {
        const userAns = answers[i] || "Not Answered";
        const isCorrect = userAns === q.answer;
        const timeSpent = perQuestionTime[i] ? perQuestionTime[i] + "s" : "0s";

        let html = `<div class="review-question">
          <p><strong>Q${q.globalIndex}:</strong> ${q.question}</p>
          <ul>`;
        q.options.forEach(opt => {
          let style = "";
          if(opt === q.answer) style = "‚úÖ Correct Answer";
          if(opt === userAns && !isCorrect) style = "‚ùå Your Choice";
          html += `<li>${opt} ${style ? "<span class='"+(opt===q.answer?"correct":"wrong")+"'>("+style+")</span>" : ""}</li>`;
        });
        html += `</ul>
          <p><strong>Your Answer:</strong> ${userAns === q.answer ? "<span class='correct'>"+userAns+"</span>" : userAns === "Not Answered" ? "<span style='color:gray'>Not Answered</span>" : "<span class='wrong'>"+userAns+"</span>"}</p>
          <p><strong>Correct Answer:</strong> <span class="correct">${q.answer}</span></p>
          <p><strong>Time Spent:</strong> ${timeSpent}</p>
          <div class="explanation"><strong>Explanation:</strong> ${q.explanation || "No explanation provided."}</div>
        </div>`;

        reviewDiv.innerHTML += html;
      });
    }

    function toggleReview(){
      document.getElementById("reviewSection").classList.toggle("hidden");
    }

    window.onload = loadResult;
  </script>
</body>
</html>
