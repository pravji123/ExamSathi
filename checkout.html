<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Payment | Testara</title>
  <style>
    :root{
      --brand:#0074cc;
      --brand-d:#005fa3;
      --bg:#f5f7fa;
      --card:#ffffff;
      --muted:#6b7280;
      --ok:#0ea760;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:20px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px}
    h1{margin:0 0 8px;color:var(--brand)}
    .sale-banner{
      display:none;align-items:center;gap:10px;
      background:linear-gradient(135deg,#ff3b30,#ff6b6b);color:#fff;
      padding:10px 14px;border-radius:10px;font-weight:700;margin:0 0 14px
    }
    .sale-banner small{font-weight:500;opacity:.95}
    #countdown{font-weight:700}

    /* Order summary */
    .prod{display:flex;gap:14px}
    .prod img{width:96px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #eee;background:#fafafa}
    .prod h3{margin:0 0 4px;font-size:18px}
    .muted{color:var(--muted);font-size:14px}
    .price-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:8px}
    .price-row del{color:#888}
    .price-row .final{color:#e60000;font-weight:800}
    .badge{background:#ffe8e8;color:#c21d1d;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700}
    .qty{margin-top:12px;display:flex;align-items:center;gap:10px}
    .qty input{width:72px;padding:8px;border:1px solid #ddd;border-radius:8px}

    .totals{margin-top:14px;border-top:1px dashed #e5e7eb;padding-top:12px}
    .totals .row{display:flex;justify-content:space-between;margin:6px 0}
    .totals .row.bold{font-weight:800}
    .save{color:var(--ok);font-weight:700}

    /* Form + Payments */
    form .field{margin-bottom:12px}
    label{display:block;font-size:14px;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"]{
      width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px
    }
    .pmethods{display:flex;gap:8px;margin:8px 0 14px}
    .tab{padding:10px 12px;border:1px solid #dbe2ea;border-radius:10px;background:#f8fafc;cursor:pointer;font-weight:700}
    .tab.active{background:#eaf3ff;border-color:#cfe3ff;color:#0b57d0}
    .help{font-size:13px;color:var(--muted)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 16px;border:none;border-radius:10px;background:var(--brand);color:#fff;
      font-weight:800;cursor:pointer
    }
    .btn:hover{background:var(--brand-d)}
    .btn.outline{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .disclaimer{font-size:12px;color:var(--muted);margin-top:10px}
    .row-flex{display:flex;gap:10px;flex-wrap:wrap}

    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-size:12px;font-weight:700}
    .warn{color:var(--danger);font-weight:700}
    .hr{height:1px;background:#eef2f7;margin:12px 0}

    /* QR code */
    #qrcode{ margin-top:10px;
      align-items: center;
    }

    /* Sticky resume on mobile */
    @media (max-width:900px){
      .sticky-total{position:sticky;bottom:0;left:0;right:0;background:#fff;padding:10px;border-top:1px solid #eee;box-shadow:0 -6px 18px rgba(0,0,0,.06);z-index:5;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="wrap">
    <div class="sale-banner" id="saleBanner">
      <span>üî• Global Offer</span>
      <span id="offerText" class="pill"></span>
      <small id="countdown">Ends in ‚Äî</small>
    </div>

    <h1>Checkout</h1>
    <p class="muted">Complete your purchase securely. Digital delivery via email / WhatsApp right after confirmation.</p>

    <div class="grid">
      <!-- Left: Order summary -->
      <section class="card" id="orderCard">
        <div class="prod">
          <img id="pimg" src="" alt="ebook">
          <div>
            <h3 id="ptitle">Loading‚Ä¶</h3>
            <div class="muted" id="pcat"></div>
            <div class="price-row">
              <del id="porig"></del>
              <span class="final" id="pfinal"></span>
              <span class="badge" id="pbadge" style="display:none"></span>
            </div>
            <div class="qty">
              <label for="qty">Qty</label>
              <input id="qty" type="number" min="1" value="1">
              <span class="muted">Instant digital delivery</span>
            </div>
          </div>
        </div>

        <div class="totals">
          <div class="row"><span>Subtotal</span><span id="subtotal">‚Çπ0</span></div>
          <div class="row"><span>Discount</span><span id="discount">‚Äì ‚Çπ0</span></div>
          <div class="row"><span>Shipping</span><span>‚Çπ0</span></div>
          <div class="row bold"><span>Total</span><span id="grand">‚Çπ0</span></div>
          <div class="row"><span class="save" id="saveText"></span><span id="discountPercentText" class="pill"></span></div>
        </div>

        <div class="sticky-total">
          <div class="row-flex">
            <span class="pill">Secure ‚Ä¢ 256-bit</span>
            <span class="pill">Instant PDF access</span>
            <span class="pill">Support: 8392950977</span>
          </div>
        </div>

        <h3>Payment Method</h3>
        <div class="pmethods">
          <button class="tab active" data-method="upi" type="button">UPI</button>
          <button class="tab" data-method="qrcode" type="button">QR Code</button>
          <button class="tab" data-method="card" type="button" title="Coming soon" aria-disabled="true">Card (soon)</button>
        </div>
        <div id="upiQR" style="margin-top:5px;text-align:center;">
          <p class="help">Or scan this QR code with your UPI app:</p>
          <div style="align-items: center;text-align: center;" id="qrcode"></div>
        </div>

        <!-- UPI Pay -->
        <div id="UPIBox">
          <p class="help">Pay using any UPI app (GPay/PhonePe/Paytm/BHIM). Copy the UPI ID, tap ‚ÄúPay via UPI‚Äù, or scan QR code.</p>
          <div class="row-flex">
            <input type="text" id="upiID" value="917492950977@upi" readonly style="flex:1;padding:10px;border:1px solid #d1d5db;border-radius:10px">
            <button class="btn outline" id="copyUPI" type="button">Copy UPI ID</button>
          </div>
          <div class="hr"></div>
          <button class="btn" id="payUPI" type="button">Pay via UPI app</button>
        </div>
      </section>

      <!-- Right: Buyer + Payment -->
      <section class="card">
        <h3>Buyer Details</h3>
        <form id="buyerForm">
          <div class="field"><label>Name</label><input type="text" id="name" required placeholder="Your full name"></div>
          <div class="field"><label>Email</label><input type="email" id="email" required placeholder="you@example.com"></div>
          <div class="field"><label>WhatsApp / Phone</label><input type="tel" id="phone" required placeholder="10-digit number"></div>
          <div class="field"><label>UPI Transaction Id / UPI Ref No / UTR</label><input type="number" id="uti" required placeholder="12-digit Transaction ID"></div>
        </form>

        <div class="hr"></div>

        <div>
          <p class="disclaimer">After you complete the payment, click ‚ÄúI‚Äôve paid‚Äù to notify us with your details. You‚Äôll receive the PDF on your email/WhatsApp.</p>
          <button class="btn outline" id="confirmPaid" type="button">I‚Äôve paid ‚Äì Send confirmation</button>
        </div>

        <!-- Card placeholder -->
        <div id="CardBox" style="display:none">
          <p class="help warn">Card payments will be available soon. Please use UPI for now.</p>
        </div>
      </section>
    </div>
  </div>
  <div id="footer"></div><script src="load-header-footer.js"></script>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  

  <script>
    // ====== CONFIG ======
    const UPI_ID = "917492950977@upi";
    const SUPPORT_WHATSAPP = "8392950977";
    const CURRENCY = "INR";

    const fmt = n => "‚Çπ" + Number(n).toLocaleString("en-IN");
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("id");

    let book = null;
    let globalOffer = 0;
    let validTill = null;
    let offerValid = false;
    let originalPrice = 0;
    let finalUnitPrice = 0;
    let discountPercent = 0;

    // ====== LOAD DATA ======
    Promise.all([
      fetch("global_offer.json").then(r => r.json()).catch(() => ({ globalOffer: 0, validTill: null })),
      fetch("ebooks.json").then(r => r.json())
    ]).then(([offerData, ebooksData]) => {
      const ebooks = Array.isArray(ebooksData) ? ebooksData : (ebooksData.ebooks || []);
      book = ebooks.find(b => b.ebookId === bookId) || ebooks[0];

      if (!book) { alert("Book not found."); return; }

      qs("#pimg").src = book.image;
      qs("#ptitle").innerText = book.title;
      qs("#pcat").innerText = (book.category || "").toUpperCase();
      originalPrice = parseFloat(book.originalPrice);

      globalOffer = Number(offerData.globalOffer || offerData.global || 0);
      validTill = offerData.validTill ? new Date(offerData.validTill) : null;
      offerValid = globalOffer > 0 && validTill && new Date() <= validTill;

      applyPricing();
      renderGlobalBanner();

      qs("#qty").addEventListener("input", () => { recalcTotals(); generateUPIQR(); });
      qsa(".tab").forEach(btn => btn.addEventListener("click", onTab));
      qs("#copyUPI").addEventListener("click", onCopyUPI);
      qs("#payUPI").addEventListener("click", onPayUPI);
      qs("#confirmPaid").addEventListener("click", onConfirmPaid);
      qs("#name").addEventListener("input", generateUPIQR);

      document.addEventListener("DOMContentLoaded", () => { qs("#upiID").value = UPI_ID; generateUPIQR(); });
    });

    function applyPricing(){
      if(offerValid){
        finalUnitPrice = Math.round(originalPrice*(1-globalOffer/100));
        discountPercent = globalOffer;
        qs("#pbadge").style.display="inline-block";
        qs("#pbadge").innerText=`-${discountPercent}% Global`;
      } else {
        finalUnitPrice = parseFloat(book.discountPrice);
        discountPercent = Math.round(((originalPrice-finalUnitPrice)/originalPrice)*100);
        qs("#pbadge").style.display = discountPercent>0?"inline-block":"none";
        qs("#pbadge").innerText = discountPercent>0?`-${discountPercent}%`:"";
      }
      qs("#porig").innerText = fmt(originalPrice);
      qs("#pfinal").innerText = fmt(finalUnitPrice);
      qs("#discountPercentText").innerText = discountPercent?`(${discountPercent}% OFF)`:"";
      recalcTotals();
    }

    function recalcTotals(){
      const qty = Math.max(1, Number(qs("#qty").value || 1));
      const subtotal = originalPrice*qty;
      const total = finalUnitPrice*qty;
      const save = subtotal-total;
      qs("#subtotal").innerText = fmt(subtotal);
      qs("#discount").innerText = "‚Äì "+fmt(save);
      qs("#grand").innerText = fmt(total);
      qs("#saveText").innerText = save>0?`You save ${fmt(save)}`:"";
    }

    function renderGlobalBanner(){
      if(!offerValid){ qs("#saleBanner").style.display="none"; return; }
      qs("#saleBanner").style.display="flex";
      qs("#offerText").innerText = `${globalOffer}% OFF (Global)`;
      let timerId=null;
      const tick=()=>{
        const dist = validTill.getTime()-Date.now();
        if(dist<=0){ clearInterval(timerId); offerValid=false; qs("#saleBanner").style.display="none"; applyPricing(); return; }
        const d=Math.floor(dist/(1000*60*60*24));
        const h=Math.floor((dist%(1000*60*60*24))/(1000*60*60));
        const m=Math.floor((dist%(1000*60*60))/(1000*60));
        const s=Math.floor((dist%(1000*60))/1000);
        qs("#countdown").innerText=`Ends in ${d}d ${h}h ${m}m ${s}s`;
      };
      tick(); timerId=setInterval(tick,1000);
    }

    // Hide QR by default
    qs("#upiQR").style.display = "none";
    function onTab(e){
      qsa(".tab").forEach(t=>t.classList.remove("active"));
      e.currentTarget.classList.add("active");
      const method = e.currentTarget.dataset.method;
      qs("#UPIBox").style.display = method==="upi"?"block":"none";
      qs("#CardBox").style.display = method==="card"?"block":"none";
      if(method === "qrcode"){
        qs("#upiQR").style.display = "block"; // Show QR section
        generateUPIQR();
      } else {
        qs("#upiQR").style.display = "none"; // Hide QR section
      }
    }
    

    function onCopyUPI(){
      const upi = qs("#upiID");
      upi.select(); upi.setSelectionRange(0, UPI_ID.length);
      document.execCommand("copy"); upi.blur();
      alert("UPI ID copied!");
    }

    function onPayUPI(){
      const name = (qs("#name").value || "Testara").trim();
      const qty = Math.max(1, Number(qs("#qty").value || 1));
      const amount = finalUnitPrice*qty;
      const txnNote = encodeURIComponent(`${book.title} x${qty}`);
      const payee = encodeURIComponent(UPI_ID);
      const payeeName = encodeURIComponent(name);
      const amt = encodeURIComponent(amount.toFixed(2));
      const url = `upi://pay?pa=${payee}&pn=${payeeName}&am=${amt}&cu=${CURRENCY}&tn=${txnNote}`;
      window.location.href = url;
    }

    function generateUPIQR(){
      const name = (qs("#name").value || "Testara").trim();
      const qty = Math.max(1, Number(qs("#qty").value || 1));
      const amount = finalUnitPrice*qty;
      const txnNote = encodeURIComponent(`${book.title} x${qty}`);
      const upiLink = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent(name)}&am=${encodeURIComponent(amount.toFixed(2))}&cu=${CURRENCY}&tn=${txnNote}`;
      const qrContainer = qs("#qrcode");
      qrContainer.innerHTML = "";
      new QRCode(qrContainer, { text:upiLink, width:180, height:180 });
    }

    function onConfirmPaid(){
      const name=qs("#name").value.trim(), email=qs("#email").value.trim(), phone=qs("#phone").value.trim(), utr=qs("#uti").value.trim();
      if(!name || !email || !/^\S+@\S+\.\S+$/.test(email) || !/^\d{10}$/.test(phone) || !/^\d{12}$/.test(utr)){
        alert("Please enter valid Name, E-mail, 10-digit Phone and 12-digit Transaction id"); return;
      }
      alert(`Thank you ${name}! Payment info sent. PDF will be delivered via WhatsApp/Email.`);
      // Here you can integrate your server API to store payment info
    }
  </script>
</body>
</html>
